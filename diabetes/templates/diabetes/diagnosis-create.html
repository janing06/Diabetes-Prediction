{% extends 'diabetes/base.html' %}
{% block title %} Add Diagnosis {% endblock %}
{% block content %}

<x-app-layout>
     <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4">
		<div class="d-block mb-md-0">
			<h2 class="h4">Add Diagnosis</h2>
		</div>
	</div>
	<div class="row justify-content-center mb-4">
		<div class="col-12 col-xl-10">

			<div class="card card-body border-0 shadow-lg mb-4 p-5">
				<h2 class="h5 mb-4">Diagnosis information</h2>

				<form method="POST" action="">
					{% csrf_token %}
					<div class="row">
						<div class="col-md-8 mb-3">
                                   <label for="patient">Patient<span class="text-danger">*</span><input name="patient" type="" readonly id="patientID" style="display: none;"></label>
                                   <div class="input-group" id="patient">
                                        <input type="text" class="form-control" placeholder="Search ID..." name="" id="autocomplete-input">
                                        <select class="form-select" name="" id="suggestions-list">
                                        </select>
                                        <input type="text" class="form-control" placeholder="" required readonly name="" id="selectedID">
                                   </div>
						</div>
                              <div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="date">Date<span class="text-danger">*</span></label>
								<input class="form-control" name="date" required type="date" id="date">
							</div>
						</div>
						<div class="col-md-12 mb-3">
							<div class="form-group">
								<label for="">Description</label>
                                        <textarea class="form-control" name="description" placeholder="Description.."  aria-label="With textarea"></textarea> 
                                   </div>
						</div>	
						<!-- <div class="col-md-6 mb-3">
							<div class="form-group">
								<label for="age">Current Age<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="current_age" required id="age" placeholder="Age">
							</div>
						</div> -->
                              <div class="col-md-6 mb-3">
							<div class="form-group">
								<label for="weight">Current Weight (kg)<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="current_weight" required step="0.01" id="weight" placeholder="Weight">
							</div>
						</div>
						<div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="test1">Pregnancies (No.)<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="test_pregnancies" id="test1" placeholder="Pregnancies">
							</div>
						</div>
						<div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="test2">Glocuse<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="test_glucose" id="test2" placeholder="Glocuse">
							</div>
						</div>
                              <div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="test3">Blood Pressure<span class="text-danger">*</span></label>
								<input class="form-control" min="1" max="200" type="number" name="test_blood_pressure" id="test3" placeholder="Blood Pressure">
							</div>
						</div>
						<div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="test3">Skin Thickness<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="test_skin_thickness" id="test3" placeholder="Skin Thickness">
							</div>
						</div>
						<div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="test3">Insulin<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="test_insulin"  id="test3" placeholder="Insulin">
							</div>
						</div>
						<div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="test3">BMI (Body Mass Index)<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="test_bmi" required step="0.01" id="test3" placeholder="BMI">
							</div>
						</div>
						<div class="col-md-4 mb-3">
							<div class="form-group">
								<label for="test3">Diabetes Pedigree Function<span class="text-danger">*</span></label>
								<input class="form-control" type="number" name="test_diabetes_pedigree_function" required step="0.001" id="test3" placeholder="Diabetes Pedigree Function">
							</div>
						</div>
					</div>
					<div class="mt-3">
						<button class="btn btn-gray-800 mt-2 animate-up-2" type="submit">Save</button>
					</div>

				</form>

			</div>

		</div>
	</div>
</x-app-layout>
   
  
   

     <script>
          const autocompleteInput = document.getElementById('autocomplete-input');
          const suggestionsList = document.getElementById('suggestions-list');
          const selectedID = document.getElementById('selectedID');
          const patientID = document.getElementById('patientID');

		function checkValidation(){
			if(selectedID.value === ''){
				selectedID.classList.add('is-invalid')
				selectedID.classList.remove('is-valid')
			}else{
				selectedID.classList.add('is-valid')
				selectedID.classList.remove('is-invalid')
			}
		}

		window.addEventListener('load', checkValidation)

		document.addEventListener('click', checkValidation)

		suggestionsList.addEventListener('click', () => {
			const selectedOption = suggestionsList.options[suggestionsList.selectedIndex];
			if (selectedOption) {
				selectedID.value = selectedOption.textContent;
				patientID.value = selectedOption.value
			}
		 });

          autocompleteInput.addEventListener('input', async function () {
          const query = this.value.trim();
          suggestionsList.innerHTML = '';

          if (query.length === 0) {
               return;
          }

          try {
               const response = await fetch(`/patient_api/?q=${query}`);
               if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
               }

               const data = await response.json();

               console.log(data)

               data.forEach(patient => {
                    console.log(patient.custom_patient_id)
                    const suggestionItem = document.createElement('option');
                    suggestionItem.value = patient.id
                    suggestionItem.textContent = patient.custom_patient_id
                    suggestionsList.appendChild(suggestionItem);
               });
          } catch (error) {
               console.error('Error:', error);
          }
          });
     </script>
{% endblock %}