{% extends 'diabetes/base.html' %}
{% load static %}
{% block title %} Dashboard {% endblock %}
{% block content %}
<x-app-layout>

	<div class="row py-4">
		<div class="col-12 col-sm-6 col-xl-4 mb-4">
			<div class="card border-0 shadow-lg">
				<div class="card-body">
					<div class="row d-block d-xl-flex align-items-center">
						<div
							class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
							<div class="icon-shape icon-shape-danger rounded me-4 me-sm-0">
								<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-journal-medical" viewBox="0 0 16 16">
									<path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v.634l.549-.317a.5.5 0 1 1 .5.866L9 6l.549.317a.5.5 0 1 1-.5.866L8.5 6.866V7.5a.5.5 0 0 1-1 0v-.634l-.549.317a.5.5 0 1 1-.5-.866L7 6l-.549-.317a.5.5 0 0 1 .5-.866l.549.317V4.5A.5.5 0 0 1 8 4zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
									<path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
									<path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
								</svg>
							</div>
							<div class="d-sm-none">
								<h2 class="h5">Total Diagnosed</h2>
								<h3 class="fw-extrabold mb-1">{{ diagnos.count }}</h3>
							</div>
						</div>
						<div class="col-12 col-xl-7 px-xl-0">
							<div class="d-none d-sm-block">
								<h2 class="h6 text-gray-400 mb-0">Total Diagnosed</h2>
								<h3 class="fw-extrabold mb-2">{{ diagnos.count }}</h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- <div class="col-12 col-sm-6 col-xl-4 mb-4">
			<div class="card border-0 shadow animate-up-1">
				<div class="card-body">
					<div class="row d-block d-xl-flex align-items-center">
						<div
							class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
							<div class="icon-shape icon-shape-secondary rounded me-4 me-sm-0">
								<svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z"
										clip-rule="evenodd"></path>
								</svg>
							</div>
							<div class="d-sm-none">
								<h2 class="fw-extrabold h5"># of Users/h2>
								<h3 class="mb-1">{{ users.count }}</h3>
                                        
							</div>
						</div>
						<div class="col-12 col-xl-7 px-xl-0">
							<div class="d-none d-sm-block">
								<h2 class="h6 text-gray-400 mb-0"># of Users</h2>
								<h3 class="fw-extrabold mb-2">{{ users.count }}</h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div> -->

          
		<div class="col-12 col-sm-6 col-xl-4 mb-4">
			<div class="card border-0 shadow-lg">
				<div class="card-body">
					<div class="row d-block d-xl-flex align-items-center">
						<div
							class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
							<div class="icon-shape icon-shape-warning rounded me-4 me-sm-0">
								<svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
									<path
										d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z">
									</path>
								</svg>
							</div>
							<div class="d-sm-none">
								<h2 class="fw-extrabold h5">Total Patients</h2>
								<h3 class="mb-1">{{ patients.count }}</h3>
							</div>
						</div>
						<div class="col-12 col-xl-7 px-xl-0">
							<div class="d-none d-sm-block">
								<h2 class="h6 text-gray-400 mb-0">Total Patients</h2>
								<h3 class="fw-extrabold mb-2">{{ patients.count }}</h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="col-12 col-sm-6 col-xl-4 mb-4">
			<div class="card border-0 shadow-lg">
				<div class="card-body">
					<div class="row d-block d-xl-flex align-items-center">
						<div
							class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
							<div class="icon-shape icon-shape-info rounded me-4 me-sm-0">
								<svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
									<path fill-rule="evenodd"
										d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z"
										clip-rule="evenodd"></path>
								</svg>
							</div>
							<div class="d-sm-none">
								<h2 class="fw-extrabold h5">Diagnosed this Year</h2>
								<h3 class="mb-1">{{ current_year_diagnoses.count }}</h3>
							</div>
						</div>
						<div class="col-12 col-xl-7 px-xl-0">
							<div class="d-none d-sm-block">
								<h2 class="h6 text-gray-400 mb-0">Diagnosed this year</h2>
								<h3 class="fw-extrabold mb-2">{{ current_year_diagnoses.count }}</h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-12 col-sm-12 col-md-12 col-xl-8 mb-4">
			<div class="card border-0 shadow-lg">
				
				<div class="card-body">
					<select class="form-select ms-auto" name="period" id="periodSelect" onchange="handleChange(this)" style="width: 220px;">
						<option value="yearly">Annually</option>
						<option value="monthly">Current Year ({{ current_year }})</option>
					 </select>
					<div>
						<canvas id="barChart"></canvas>
					</div>
				</div>
			</div>
		</div>

		<div class="col-4 col-sm-4 col-xl-4 mb-4">
			<div class="card border-0 shadow-lg">
				<div class="card-body">
					<select class="form-select ms-auto" name="period" id="periodSelect" onchange="pieChartSelection(this)">
						<option value="total">Total</option>
						<option value="currentYear">Current Year ({{ current_year }})</option>
					 </select>
					<div>
						<canvas id="pieChart"></canvas>
					</div>
					
				</div>
			</div>
		</div>
        

	</div>
	<script>

		const yearly_diagnosed = JSON.parse('{{ json_yearly_diagnosed|safe }}')
		const monthly_diagnosed = JSON.parse('{{ json_monthly_this_year_diagnosed|safe }}')

		console.log(monthly_diagnosed)


		const bar = document.getElementById('barChart');
	   
		const barChart = new Chart(bar, {
		  type: 'bar',
		  data: {
		    labels: yearly_diagnosed.map(item => item.date),
		    datasets: [{
			 label: 'Annually',
			 data: yearly_diagnosed.map(item => item.total),
			 borderWidth: 1
		    }]
		  },
		  options: {
		    scales: {
			 y: {
			   beginAtZero: true,
			   ticks: {
				stepSize: 1
			 }
			 }
		    }
		  }
		});


		
		function handleChange(select) {
			var selectedValue = select.value;
			
			if (selectedValue === "monthly") {
			    monthly();
			} else if (selectedValue === "yearly") {
			    yearly();
			}
		 }

		 console.log('{{ pis }}')
		 
		 function monthly() {
			console.log('Monthly')
			barChart.data.labels = monthly_diagnosed.map(item => item.date)
			barChart.data.datasets[0].data = monthly_diagnosed.map(item => item.total)
			barChart.data.datasets[0].label = 'Current Year (Monthly)'
			barChart.update();

		 }
		 	
		 function yearly() {
			console.log('Yearly');
			barChart.data.labels = yearly_diagnosed.map(item => item.date)
			barChart.data.datasets[0].data = yearly_diagnosed.map(item => item.total)
			barChart.data.datasets[0].label = 'Annually'
			barChart.update();
		 }


		const pie = document.getElementById('pieChart');
		
		const pieChart = new Chart(pie, {
		type: 'pie',
		data: {
			labels: [
			  'Positive ({{ positive_count }})',
			  'Negative ({{ negative_count }})',
			],
			datasets: [{
			  label: 'Prediction',
			  data: ['{{ positive_count }}', '{{ negative_count }}'],
			  backgroundColor: [
			    'rgb(255, 20, 50)',
			    'rgb(20, 255, 50)',
			  ],
			  hoverOffset: 4
			}]
		   }
		
		});

		function pieChartSelection(select) {
			var selectedValue = select.value;
			
			if (selectedValue === "total") {
				pieChart.data.datasets[0].data = ['{{ positive_count }}', '{{ negative_count }}']
				pieChart.data.labels[0] = ['Positive ({{ positive_count }})']
				pieChart.data.labels[1] = ['Negative ({{ negative_count }})']
				pieChart.update()
			} else if (selectedValue === "currentYear") {
				pieChart.data.datasets[0].data = ['{{ positive_count_yearly }}', '{{ negative_count_yearly }}']
				pieChart.data.labels[0] = ['Positive ({{ positive_count_yearly }})']
				pieChart.data.labels[1] = ['Negative ({{ negative_count_yearly }})']
				pieChart.update()
			}
		 }

	   </script>
</x-app-layout>
{% endblock %}